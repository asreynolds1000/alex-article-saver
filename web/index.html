<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#6366f1">
  <meta name="description" content="Your personal reading stash">

  <title>Stash</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon192.png">

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Markdown parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- SQL.js for parsing Apple Podcasts SQLite database -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
</head>
<body>
  <div id="app">
    <!-- Auth Screen -->
    <div id="auth-screen" class="screen">
      <div class="auth-container">
        <div class="logo">
          <div class="logo-icon">S</div>
          <h1>Stash</h1>
          <p>Your personal reading stash</p>
        </div>

        <div class="auth-buttons">
          <button type="button" class="btn google-btn" id="google-signin-btn">
            <svg width="18" height="18" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Sign in with Google
          </button>
        </div>
        <p id="auth-error" class="error"></p>
        <p id="auth-message" class="message"></p>
      </div>
    </div>

    <!-- Main App -->
    <div id="main-screen" class="screen hidden">
      <!-- Sidebar Overlay (for mobile) -->
      <div id="sidebar-overlay" class="sidebar-overlay"></div>

      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="logo-small">S</div>
          <span>Stash</span>
        </div>

        <nav class="nav">
          <a href="#" class="nav-item active" data-view="all">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            </svg>
            All Saves
          </a>
          <a href="#" class="nav-item" data-view="highlights">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
              <path d="M2 17l10 5 10-5"></path>
              <path d="M2 12l10 5 10-5"></path>
            </svg>
            Highlights
          </a>
          <a href="#" class="nav-item" data-view="articles">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            Articles
          </a>
          <a href="#" class="nav-item" data-view="kindle">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg>
            Kindle
          </a>
          <a href="#" class="nav-item" data-view="podcasts">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
              <line x1="12" y1="19" x2="12" y2="23"></line>
              <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
            Podcasts
          </a>
          <a href="#" class="nav-item" data-view="books">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
              <line x1="12" y1="6" x2="12" y2="12"></line>
              <line x1="9" y1="9" x2="15" y2="9"></line>
            </svg>
            Books
          </a>
          <a href="#" class="nav-item" data-view="archived">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="21 8 21 21 3 21 3 8"></polyline>
              <rect x="1" y="3" width="22" height="5"></rect>
              <line x1="10" y1="12" x2="14" y2="12"></line>
            </svg>
            Archived
          </a>
          <a href="#" class="nav-item" data-view="weekly">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            Weekly Review
          </a>
          <a href="#" class="nav-item" data-view="insights">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
              <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
            Insights
          </a>
        </nav>

        <div class="nav-section">
          <h3>Folders</h3>
          <div id="folders-list"></div>
          <button class="add-folder-btn" id="add-folder-btn">+ New Folder</button>
        </div>

        <div class="nav-section">
          <h3>Tags</h3>
          <div id="tags-list" class="tags-cloud"></div>
        </div>

        <div class="nav-section">
          <h3>Add Content</h3>
          <button class="add-folder-btn" id="book-add-btn">Add Book</button>
          <button class="add-folder-btn" id="podcast-add-btn">Add Podcast Transcript</button>
          <button class="add-folder-btn" id="kindle-import-btn">Import Kindle</button>
          <button class="add-folder-btn" id="apple-podcasts-import-btn">Import Apple Podcasts</button>
        </div>

        <div class="nav-section">
          <button class="nav-item" id="settings-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            Settings
          </button>
          <button class="nav-item ai-jobs-btn" id="ai-jobs-btn">
            <span class="ai-jobs-spinner hidden"></span>
            <svg class="ai-jobs-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
              <path d="M2 17l10 5 10-5"></path>
              <path d="M2 12l10 5 10-5"></path>
            </svg>
            <span class="ai-jobs-label">AI Jobs</span>
            <span class="ai-jobs-count hidden" id="ai-jobs-count">0</span>
          </button>
          <a href="#" class="nav-item" data-view="stats">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="20" x2="18" y2="10"></line>
              <line x1="12" y1="20" x2="12" y2="4"></line>
              <line x1="6" y1="20" x2="6" y2="14"></line>
            </svg>
            Stats
          </a>
        </div>

        <!-- Sticky footer with Sign Out -->
        <div class="sidebar-footer-sticky">
          <button class="nav-item signout-btn" id="signout-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Sign Out
          </button>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main">
        <!-- Header -->
        <header class="main-header">
          <div class="search-container">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="search-input" placeholder="Search your stash...">
          </div>
          <button class="btn icon" id="mobile-menu-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </button>
        </header>

        <!-- Content Area -->
        <div class="content">
          <div class="content-header">
            <h2 id="view-title">All Saves</h2>
            <div class="view-controls">
              <select id="sort-select">
                <option value="created_at.desc">Newest first</option>
                <option value="created_at.asc">Oldest first</option>
                <option value="title.asc">Title A-Z</option>
              </select>
            </div>
          </div>

          <div id="saves-container" class="saves-grid">
            <!-- Saves will be loaded here -->
          </div>

          <div id="loading" class="loading hidden">
            <div class="spinner"></div>
          </div>

          <div id="empty-state" class="empty-state hidden">
            <div class="empty-icon">ðŸ“š</div>
            <h3>No saves yet</h3>
            <p>Install the Chrome extension to start saving articles and highlights.</p>
          </div>
        </div>
      </main>

      <!-- Reading Pane (for viewing saved content) -->
      <aside id="reading-pane" class="reading-pane hidden">
        <div class="reading-header">
          <button class="btn icon" id="close-reading-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
          <div class="reading-actions">
            <button class="btn icon" id="archive-btn" title="Archive">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="21 8 21 21 3 21 3 8"></polyline>
                <rect x="1" y="3" width="22" height="5"></rect>
              </svg>
            </button>
            <button class="btn icon" id="favorite-btn" title="Favorite">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
              </svg>
            </button>
            <button class="btn icon" id="delete-btn" title="Delete">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
            </button>
            <a id="open-original-btn" href="#" target="_blank" class="btn icon" title="Open original">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                <polyline points="15 3 21 3 21 9"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
              </svg>
            </a>
          </div>
        </div>
        <div class="reading-progress-bar">
          <div class="reading-progress-fill" id="reading-progress-fill"></div>
        </div>
        <div class="reading-content" id="reading-content">
          <div id="reading-meta" class="reading-meta"></div>
          <!-- Audio Player -->
          <div id="audio-player" class="audio-player hidden">
            <button class="audio-play-btn" id="audio-play-btn" title="Play audio">
              <svg class="play-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
              <svg class="pause-icon hidden" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <rect x="6" y="4" width="4" height="16"></rect>
                <rect x="14" y="4" width="4" height="16"></rect>
              </svg>
            </button>
            <div class="audio-progress-container">
              <div class="audio-time" id="audio-current">0:00</div>
              <div class="audio-progress-bar" id="audio-progress-bar">
                <div class="audio-progress" id="audio-progress"></div>
              </div>
              <div class="audio-time" id="audio-duration">0:00</div>
            </div>
            <select class="audio-speed" id="audio-speed" title="Playback speed">
              <option value="0.75">0.75x</option>
              <option value="1" selected>1x</option>
              <option value="1.25">1.25x</option>
              <option value="1.5">1.5x</option>
              <option value="2">2x</option>
            </select>
          </div>
          <div id="audio-generating" class="audio-generating hidden">
            <div class="audio-generating-spinner"></div>
            <span>Generating audio...</span>
          </div>
          <h1 id="reading-title"></h1>
          <div id="reading-body" class="reading-body"></div>
        </div>
        <div class="reading-tags">
          <div id="reading-tags-list"></div>
          <button class="add-tag-btn" id="add-tag-btn">+ Add tag</button>
        </div>
      </aside>
    </div>

    <!-- Stats Screen -->
    <div id="stats-screen" class="screen hidden">
      <!-- Will be populated by JS -->
    </div>

    <!-- Kindle Import Modal -->
    <div id="kindle-import-modal" class="modal hidden">
      <div class="modal-overlay"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2>Import Kindle Highlights</h2>
          <button class="btn icon modal-close-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div id="kindle-dropzone" class="dropzone">
            <div class="dropzone-content">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <p>Drag and drop your <strong>My Clippings.txt</strong> file here</p>
              <span class="dropzone-hint">or click to browse</span>
            </div>
            <input type="file" id="kindle-file-input" accept=".txt" hidden>
          </div>
          <p class="import-help">
            Find this file on your Kindle device at <code>/documents/My Clippings.txt</code>
          </p>
          <div id="kindle-import-preview" class="import-preview hidden">
            <div class="import-stats">
              <div class="import-stat">
                <span class="import-stat-value" id="import-total">0</span>
                <span class="import-stat-label">highlights found</span>
              </div>
              <div class="import-stat">
                <span class="import-stat-value" id="import-books">0</span>
                <span class="import-stat-label">books</span>
              </div>
              <div class="import-stat">
                <span class="import-stat-value" id="import-duplicates">0</span>
                <span class="import-stat-label">duplicates</span>
              </div>
            </div>
            <div class="import-books-list" id="import-books-list"></div>
          </div>
        </div>
        <div class="modal-footer hidden" id="kindle-import-footer">
          <button class="btn secondary" id="kindle-cancel-btn">Cancel</button>
          <button class="btn primary" id="kindle-confirm-btn">Import Highlights</button>
        </div>
      </div>
    </div>

    <!-- Unified Settings Modal -->
    <div id="settings-modal" class="modal hidden">
      <div class="modal-overlay"></div>
      <div class="modal-content settings-modal-content">
        <div class="modal-header">
          <h2>Settings</h2>
          <button class="btn icon modal-close-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body settings-modal-body">
          <!-- Settings Tabs -->
          <div class="settings-tabs">
            <button class="settings-tab active" data-tab="appearance">Appearance</button>
            <button class="settings-tab" data-tab="ai">AI</button>
            <button class="settings-tab" data-tab="digest">Digest</button>
            <button class="settings-tab" data-tab="audio">Audio</button>
          </div>

          <!-- Appearance Tab -->
          <div class="settings-tab-content active" id="settings-tab-appearance">
            <div class="form-group">
              <label class="toggle-label">
                <input type="checkbox" id="settings-dark-mode">
                <span class="toggle-switch"></span>
                <span>Dark Mode</span>
              </label>
              <small class="form-hint">Switch between light and dark themes</small>
            </div>
          </div>

          <!-- AI Tab -->
          <div class="settings-tab-content hidden" id="settings-tab-ai">
            <p class="settings-description">Configure AI for transcript processing and content enrichment. Your API keys are stored locally in your browser.</p>

            <!-- Model Tier Selection -->
            <div class="form-group">
              <label>Model Tier</label>
              <div class="tier-selection" id="ai-tier-selection">
                <label class="tier-option">
                  <input type="radio" name="ai-tier" value="fast">
                  <div class="tier-card">
                    <span class="tier-name">Fast</span>
                    <span class="tier-desc">Quick responses, lower cost</span>
                  </div>
                </label>
                <label class="tier-option">
                  <input type="radio" name="ai-tier" value="balanced" checked>
                  <div class="tier-card">
                    <span class="tier-name">Balanced</span>
                    <span class="tier-desc">Best balance of speed and quality</span>
                    <span class="tier-badge">Recommended</span>
                  </div>
                </label>
                <label class="tier-option">
                  <input type="radio" name="ai-tier" value="quality">
                  <div class="tier-card">
                    <span class="tier-name">Quality</span>
                    <span class="tier-desc">Best results, slower</span>
                  </div>
                </label>
              </div>
              <small class="form-hint" id="ai-tier-hint">Select the performance tier for AI processing</small>
            </div>

            <!-- Provider Selection -->
            <div class="form-group">
              <label for="ai-provider">AI Provider</label>
              <select id="ai-provider">
                <option value="claude">Claude (Anthropic)</option>
                <option value="openai">OpenAI</option>
              </select>
            </div>

            <!-- Claude Configuration -->
            <div id="claude-config-group">
              <div class="form-group" id="claude-key-group">
                <label for="claude-api-key">Claude API Key</label>
                <div class="api-key-input-wrapper">
                  <input type="password" id="claude-api-key" placeholder="sk-ant-...">
                  <button type="button" class="btn icon api-key-toggle" data-target="claude-api-key" title="Show/hide key">
                    <svg class="eye-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                  </button>
                </div>
                <small class="form-hint">Get your key from <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a></small>
                <div class="api-key-actions">
                  <button type="button" class="btn small primary" id="claude-key-validate">Validate Key</button>
                  <button type="button" class="btn small secondary" id="claude-key-reset">Reset</button>
                </div>
                <div id="claude-key-status" class="api-key-status"></div>
              </div>
            </div>

            <!-- OpenAI Configuration -->
            <div id="openai-config-group" class="hidden">
              <div class="form-group" id="openai-key-group">
                <label for="openai-api-key">OpenAI API Key</label>
                <div class="api-key-input-wrapper">
                  <input type="password" id="openai-api-key" placeholder="sk-...">
                  <button type="button" class="btn icon api-key-toggle" data-target="openai-api-key" title="Show/hide key">
                    <svg class="eye-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                  </button>
                </div>
                <small class="form-hint">Get your key from <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a></small>
                <div class="api-key-actions">
                  <button type="button" class="btn small primary" id="openai-key-validate">Validate Key</button>
                  <button type="button" class="btn small secondary" id="openai-key-reset">Reset</button>
                </div>
                <div id="openai-key-status" class="api-key-status"></div>
              </div>
            </div>

            <!-- Auto-enrich Option -->
            <div class="form-group">
              <label class="toggle-label">
                <input type="checkbox" id="ai-auto-enrich">
                <span class="toggle-switch"></span>
                <span>Auto-enrich on save</span>
              </label>
              <small class="form-hint">Automatically extract publication date and tags when saving articles (uses Fast tier)</small>
            </div>

            <div id="ai-settings-status" class="settings-status hidden"></div>
          </div>

          <!-- Digest Tab -->
          <div class="settings-tab-content hidden" id="settings-tab-digest">
            <p class="settings-description">Get a weekly email with summaries of everything you saved, plus random Kindle highlights to revisit.</p>

            <div class="form-group">
              <label class="toggle-label">
                <input type="checkbox" id="digest-enabled">
                <span class="toggle-switch"></span>
                <span>Enable weekly digest</span>
              </label>
            </div>

            <div class="form-group" id="digest-options">
              <label for="digest-email">Email address</label>
              <input type="email" id="digest-email" placeholder="your@email.com">
            </div>

            <div class="form-group" id="digest-schedule-group">
              <label>Send every</label>
              <div class="schedule-row">
                <select id="digest-day">
                  <option value="0">Sunday</option>
                  <option value="1">Monday</option>
                  <option value="2">Tuesday</option>
                  <option value="3">Wednesday</option>
                  <option value="4">Thursday</option>
                  <option value="5">Friday</option>
                  <option value="6">Saturday</option>
                </select>
                <span>at</span>
                <select id="digest-hour">
                  <option value="6">6:00 AM</option>
                  <option value="7">7:00 AM</option>
                  <option value="8">8:00 AM</option>
                  <option value="9">9:00 AM</option>
                  <option value="10">10:00 AM</option>
                  <option value="11">11:00 AM</option>
                  <option value="12">12:00 PM</option>
                  <option value="17">5:00 PM</option>
                  <option value="18">6:00 PM</option>
                  <option value="19">7:00 PM</option>
                  <option value="20">8:00 PM</option>
                </select>
                <span class="timezone-hint">(UTC)</span>
              </div>
            </div>

            <div id="digest-status" class="settings-status hidden"></div>
          </div>

          <!-- Audio Tab -->
          <div class="settings-tab-content hidden" id="settings-tab-audio">
            <p class="settings-description">Configure text-to-speech audio generation for articles. Requires a TTS daemon running on your server.</p>

            <div class="form-group">
              <label class="toggle-label">
                <input type="checkbox" id="audio-enabled" disabled>
                <span class="toggle-switch"></span>
                <span>Enable audio generation</span>
              </label>
              <small class="form-hint">Audio is generated by the TTS daemon (tts/tts.py) running on your server</small>
            </div>

            <div id="audio-status" class="settings-status">
              <p>Audio generation requires running the TTS daemon separately:</p>
              <code style="display: block; margin: 8px 0; padding: 8px; background: var(--bg-secondary); border-radius: 4px;">python tts/tts.py</code>
              <p>The daemon polls for articles without audio and generates speech using Edge TTS.</p>
            </div>
          </div>

          <!-- Credits at bottom -->
          <div class="settings-credits">
            Made by <a href="https://kevinroose.com" target="_blank">Kevin Roose</a> Â·
            Forked by <a href="https://alexreynolds.com" target="_blank">Alex Reynolds</a> Â·
            Built with <a href="https://claude.ai/code" target="_blank">Claude Code</a>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn secondary" id="settings-cancel-btn">Cancel</button>
          <button class="btn primary" id="settings-save-btn">Save Settings</button>
        </div>
      </div>
    </div>

    <!-- Add Podcast Modal -->
    <div id="podcast-modal" class="modal hidden">
      <div class="modal-overlay"></div>
      <div class="modal-content podcast-modal-content">
        <div class="modal-header">
          <h2>Add Podcast Transcript</h2>
          <button class="btn icon modal-close-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="podcast-form">
            <div class="form-group">
              <label for="podcast-show-name">Podcast/Show Name</label>
              <input type="text" id="podcast-show-name" placeholder="e.g., Hard Fork, The Daily">
            </div>

            <div class="form-group">
              <label for="podcast-episode-title">Episode Title</label>
              <input type="text" id="podcast-episode-title" placeholder="e.g., Episode 123: The Future of AI">
            </div>

            <div class="form-group">
              <label for="podcast-episode-date">Episode Date</label>
              <input type="date" id="podcast-episode-date">
            </div>

            <div class="form-group">
              <label>Transcript</label>
              <div class="podcast-input-tabs">
                <button class="podcast-tab active" data-tab="paste">Paste Text</button>
                <button class="podcast-tab" data-tab="upload">Upload File</button>
              </div>

              <div class="podcast-tab-content" id="paste-tab">
                <textarea id="podcast-transcript" placeholder="Paste your transcript here..."></textarea>
              </div>

              <div class="podcast-tab-content hidden" id="upload-tab">
                <div id="podcast-dropzone" class="dropzone podcast-dropzone">
                  <div class="dropzone-content">
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="17 8 12 3 7 8"></polyline>
                      <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <p>Drop .txt or .srt file here</p>
                    <span class="dropzone-hint">or click to browse</span>
                  </div>
                  <input type="file" id="podcast-file-input" accept=".txt,.srt" hidden>
                </div>
                <div id="podcast-file-name" class="podcast-file-name hidden"></div>
              </div>
            </div>

            <div class="form-group">
              <label class="toggle-label">
                <input type="checkbox" id="podcast-prettify" checked>
                <span class="toggle-switch"></span>
                <span>Process with AI (cleanup, key points)</span>
              </label>
              <small class="form-hint" id="prettify-hint">Requires API key in AI Settings</small>
            </div>

            <div id="podcast-status" class="podcast-status hidden"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn secondary" id="podcast-cancel-btn">Cancel</button>
          <button class="btn primary" id="podcast-save-btn">Save Transcript</button>
        </div>
      </div>
    </div>

    <!-- Apple Podcasts Import Modal (Full Screen) -->
    <div id="apple-podcasts-modal" class="modal hidden">
      <div class="modal-overlay"></div>
      <div class="modal-content apple-podcasts-modal-content">
        <div class="modal-header">
          <h2>Import from Apple Podcasts</h2>
          <button class="btn icon modal-close-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body apple-podcasts-modal-body">
          <!-- Initial Drop Zone View -->
          <div id="apple-podcasts-dropzone-container" class="apple-podcasts-dropzone-container">
            <div class="apple-podcasts-instructions">
              <p>Import transcripts from the Apple Podcasts app on your Mac.</p>
              <ol>
                <li>Open <strong>Finder</strong> and press <kbd>Cmd</kbd>+<kbd>Shift</kbd>+<kbd>G</kbd></li>
                <li>Paste this path: <code>~/Library/Group Containers/243LU875E5.groups.com.apple.podcasts</code></li>
                <li>Drag the entire folder onto the box below</li>
              </ol>
              <p class="apple-podcasts-note">All files are processed locally in your browser. Nothing is uploaded.</p>
            </div>

            <div id="apple-podcasts-dropzone" class="dropzone apple-podcasts-dropzone">
              <div class="dropzone-content">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p>Drag the Apple Podcasts folder here</p>
                <span class="dropzone-hint">or drop individual .ttml files</span>
              </div>
            </div>

            <div id="apple-podcasts-processing" class="apple-podcasts-processing hidden">
              <div class="spinner"></div>
              <span>Processing files...</span>
            </div>
          </div>

          <!-- Two-Panel Preview View -->
          <div id="apple-podcasts-preview" class="apple-podcasts-preview hidden">
            <!-- Left Panel: Episode List -->
            <div class="apple-podcasts-list-panel">
              <div class="apple-podcasts-list-header">
                <div class="apple-podcasts-stats">
                  <div class="apple-podcasts-stat">
                    <span class="apple-podcasts-stat-value" id="apple-podcasts-count">0</span>
                    <span class="apple-podcasts-stat-label">transcripts found</span>
                  </div>
                  <div class="apple-podcasts-stat">
                    <span class="apple-podcasts-stat-value" id="apple-podcasts-selected-count">0</span>
                    <span class="apple-podcasts-stat-label">selected</span>
                  </div>
                </div>
                <div class="apple-podcasts-ai-option">
                  <label class="toggle-label">
                    <input type="checkbox" id="apple-podcasts-ai-cleanup">
                    <span class="toggle-switch"></span>
                    <span>AI cleanup on import</span>
                  </label>
                  <small class="form-hint" id="apple-podcasts-ai-hint">Requires API key in AI Settings</small>
                </div>
              </div>
              <div class="apple-podcasts-list" id="apple-podcasts-list"></div>
            </div>

            <!-- Right Panel: Transcript Preview -->
            <div class="apple-podcasts-preview-panel" id="apple-podcasts-preview-panel">
              <div class="apple-podcasts-preview-placeholder">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                <p>Select an episode to preview transcript</p>
              </div>
              <div class="apple-podcasts-transcript-view hidden" id="apple-podcasts-transcript-view">
                <div class="apple-podcasts-transcript-header">
                  <h3 id="apple-podcasts-transcript-title">Episode Title</h3>
                  <p id="apple-podcasts-transcript-show">Show Name</p>
                </div>
                <div class="apple-podcasts-transcript-content" id="apple-podcasts-transcript-content"></div>
              </div>
            </div>
          </div>

          <div id="apple-podcasts-status" class="apple-podcasts-status hidden"></div>
        </div>
        <div class="modal-footer hidden" id="apple-podcasts-footer">
          <button class="btn secondary" id="apple-podcasts-cancel-btn">Cancel</button>
          <button class="btn primary" id="apple-podcasts-import-btn-confirm">Import Selected</button>
        </div>
      </div>
    </div>

    <!-- AI Jobs Modal -->
    <div id="ai-jobs-modal" class="modal hidden">
      <div class="modal-overlay"></div>
      <div class="modal-content ai-jobs-modal-content">
        <div class="modal-header">
          <h2>AI Jobs</h2>
          <button class="btn icon modal-close-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div id="ai-jobs-list" class="ai-jobs-list">
            <div class="ai-jobs-empty">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <p>No AI jobs running</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Book Modal -->
    <div id="book-modal" class="modal hidden">
      <div class="modal-overlay"></div>
      <div class="modal-content book-modal-content">
        <div class="modal-header">
          <h2>Add Book</h2>
          <button class="btn icon modal-close-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="book-form">
            <!-- Search Section -->
            <div class="form-group">
              <label for="book-search">Search for a Book</label>
              <div class="book-search-wrapper">
                <input type="text" id="book-search" placeholder="Enter book title or author...">
                <button type="button" class="btn primary" id="book-search-btn">Search</button>
              </div>
              <small class="form-hint">Search Google Books to auto-fill book details</small>
            </div>

            <!-- Search Results -->
            <div id="book-search-results" class="book-search-results hidden"></div>

            <!-- Book Details Form -->
            <div id="book-details-form" class="book-details-form">
              <div class="book-selected-preview hidden" id="book-selected-preview">
                <img id="book-cover-preview" src="" alt="Book cover">
                <div class="book-preview-info">
                  <h4 id="book-preview-title"></h4>
                  <p id="book-preview-author"></p>
                </div>
                <button type="button" class="btn icon book-clear-selection" id="book-clear-selection" title="Clear selection">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="book-title">Title <span class="required">*</span></label>
                  <input type="text" id="book-title" placeholder="Book title" required>
                </div>
                <div class="form-group">
                  <label for="book-author">Author</label>
                  <input type="text" id="book-author" placeholder="Author name">
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="book-year">Year Read <span class="required">*</span></label>
                  <input type="number" id="book-year" placeholder="2024" min="1900" max="2100" required>
                </div>
                <div class="form-group">
                  <label for="book-date">Specific Date (optional)</label>
                  <input type="date" id="book-date">
                </div>
              </div>

              <div class="form-group">
                <label for="book-notes">Your Notes & Quotes</label>
                <textarea id="book-notes" placeholder="Add your personal notes, favorite quotes, or key takeaways..." rows="4"></textarea>
              </div>

              <!-- Auto-fetched Book Info -->
              <div id="book-fetched-info" class="book-fetched-info hidden">
                <h4>Book Summary</h4>
                <div id="book-description" class="book-description"></div>
                <div id="book-key-points" class="book-key-points hidden">
                  <h5>Key Points</h5>
                  <ul id="book-key-points-list"></ul>
                </div>
              </div>

              <input type="hidden" id="book-google-id">
              <input type="hidden" id="book-cover-url">
              <input type="hidden" id="book-categories">
              <input type="hidden" id="book-page-count">
              <input type="hidden" id="book-published-date">
            </div>

            <div id="book-status" class="book-status hidden"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn secondary" id="book-cancel-btn">Cancel</button>
          <button class="btn primary" id="book-save-btn">Save Book</button>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
  </div>

  <!-- Config (non-module for global CONFIG) -->
  <script src="config.js"></script>
  <!-- App (ES module) -->
  <script type="module" src="app.js"></script>

  <!-- Register Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</body>
</html>
